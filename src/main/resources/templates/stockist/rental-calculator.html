<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Rental Calculator</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f6f8fa;}
        .container { max-width: 600px; margin: 36px auto; background: #fff; padding: 30px 22px; border-radius: 13px; box-shadow: 0 2px 16px #b6c2e7;}
        h2 { color: #2a4687; text-align: center; margin-bottom: 20px;}
        label { font-weight: 600; margin-top: 12px; display: block;}
        input, select { width: 100%; padding: 8px; border-radius: 7px; border: 1px solid #c5d1e7; margin-bottom: 14px;}
        .btn { background: #274c97; color: #fff; border: none; border-radius: 7px; padding: 10px 0; width: 100%; font-size: 1.06rem; font-weight: 600; cursor:pointer;}
        .details-table { width: 100%; border-collapse: collapse; margin-top: 18px; }
        .details-table th, .details-table td { border: 1px solid #c5d1e7; padding: 6px 8px; text-align: center; }
        .details-table th { background: #f1f5fb;}
        .export-btn { margin: 6px 10px 6px 0; background:#274c97; color:#fff; border:none; border-radius:5px; padding:5px 16px;}
    </style>
</head>
<body>
<div class="container">
    <h2>Warehouse Rental Calculator</h2>
    <form id="rentalForm" onsubmit="return false;">
        <label>Stockist Name</label>
        <input list="stockistList" id="stockistName" name="stockistName"
               th:value="${stockistName}" th:readonly="${readonly}" required>
        <datalist id="stockistList">
            <option th:each="s : ${stockists}" th:value="${s}"></option>
        </datalist>

        <label>Warehouse</label>
        <input list="warehouseList" id="warehouse" name="warehouse" required>
        <datalist id="warehouseList">
            <option th:each="w : ${warehouses}" th:value="${w}"></option>
        </datalist>

        <label>Commodity</label>
        <select id="commodity" name="commodity" required>
            <option value="Wheat">Wheat</option>
            <option value="Maize">Maize</option>
            <option value="Paddy">Paddy</option>
        </select>

        <label>Upto Date</label>
        <input type="date" id="uptoDate" name="uptoDate" required>

        <button class="btn" onclick="calculateRental()">Calculate Rental</button>
    </form>

    <!-- ONLY ONE SUMMARY TABLE -->
    <table id="summaryTable" style="width:100%; margin: 20px 0; border-collapse:collapse; display:none;">
        <thead>
        <tr>
            <th>Stockist Name</th>
            <th>Warehouse</th>
            <th>Commodity</th>
            <th>Rental (₹)</th>
        </tr>
        </thead>
        <tbody>
        <tr id="summaryRow"></tr>
        </tbody>
    </table>

    <button class="btn" id="showDetailsBtn" style="display:none;" onclick="showDetails()">Show Details</button>
    <div id="detailsDiv" style="display:none;">
        <button class="export-btn" onclick="exportDetails('excel')">Export Excel</button>
        <button class="export-btn" onclick="exportDetails('pdf')">Export PDF</button>
        <table class="details-table" id="detailsTable"></table>
    </div>
</div>
<script>
    let rentalDetails = [];

    function calculateRental() {
        let stockistName = document.getElementById("stockistName").value;
        let warehouse = document.getElementById("warehouse").value;
        let commodity = document.getElementById("commodity").value;
        let uptoDate = document.getElementById("uptoDate").value;
        if(!stockistName || !warehouse || !commodity || !uptoDate) { alert("Fill all fields!"); return; }
        fetch('/stockist/rental-calculator/calculate', {
            method: "POST",
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `stockistName=${encodeURIComponent(stockistName)}&warehouse=${encodeURIComponent(warehouse)}&commodity=${commodity}&uptoDate=${uptoDate}`
        })
            .then(res => res.json())
            .then(resp => {
                let sum = resp.summary;
                // Show table and fill row
                let tbl = document.getElementById("summaryTable");
                let row = document.getElementById("summaryRow");
                row.innerHTML = `
                <td>${sum.stockistName || ''}</td>
                <td>${sum.warehouse || ''}</td>
                <td>${sum.commodity || ''}</td>
                <td>₹${(sum.rental||0).toFixed(2)}</td>
            `;
                tbl.style.display = '';
                rentalDetails = resp.details;
                document.getElementById("showDetailsBtn").style.display = rentalDetails.length > 0 ? '' : 'none';
                document.getElementById("detailsDiv").style.display = 'none';
            });
    }

    function showDetails() {
        let tbl = document.getElementById("detailsTable");
        tbl.innerHTML = "";
        let header = "<tr><th>Date</th><th>Total Stored (kg)</th><th>Exit (kg)</th><th>Net Stock (kg)</th><th>Rental (Rs)</th></tr>";
        tbl.insertAdjacentHTML('beforeend', header);
        rentalDetails.forEach(row => {
            tbl.insertAdjacentHTML('beforeend',
                `<tr><td>${row.date}</td><td>${row.stored}</td><td>${row.exited}</td><td>${row.netStock}</td><td>${row.rental.toFixed(2)}</td></tr>`);
        });
        document.getElementById("detailsDiv").style.display = '';
    }
</script>
</body>
</html>

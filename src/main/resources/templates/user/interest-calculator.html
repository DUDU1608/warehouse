<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Interest Calculator</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f6f8fa;}
        .container { max-width: 600px; margin: 36px auto; background: #fff; padding: 30px 22px; border-radius: 13px; box-shadow: 0 2px 16px #b6c2e7;}
        h2 { color: #2a4687; text-align: center; margin-bottom: 20px;}
        label { font-weight: 600; margin-top: 12px; display: block;}
        input, select { width: 100%; padding: 8px; border-radius: 7px; border: 1px solid #c5d1e7; margin-bottom: 14px;}
        .btn { background: #274c97; color: #fff; border: none; border-radius: 7px; padding: 10px 0; width: 100%; font-size: 1.06rem; font-weight: 600; cursor:pointer;}
        .details-table { width: 100%; border-collapse: collapse; margin-top: 18px; }
        .details-table th, .details-table td { border: 1px solid #c5d1e7; padding: 6px 8px; text-align: center; }
        .details-table th { background: #f1f5fb;}
        .export-btn { margin: 0 8px 10px 0; background:#274c97; color:#fff; border:none; border-radius:5px; padding:5px 16px;}
        #detailsHeader { margin-top: 20px; display: flex; justify-content: flex-end; }
    </style>
</head>
<body>
<div class="container">
    <h2>Warehouse Interest Calculator</h2>
    <form id="interestForm" onsubmit="return false;">
        <label>Stockist Name</label>
        <input type="text" id="stockistName" name="stockistName" th:value="${stockistName}" readonly required>

        <label>Warehouse</label>
        <input list="warehouseList" id="warehouse" name="warehouse" required>
        <datalist id="warehouseList">
            <option th:each="w : ${warehouses}" th:value="${w}"></option>
        </datalist>

        <label>Commodity</label>
        <select id="commodity" name="commodity" required>
            <option value="Wheat">Wheat</option>
            <option value="Maize">Maize</option>
            <option value="Paddy">Paddy</option>
        </select>

        <label>Upto Date</label>
        <input type="date" id="uptoDate" name="uptoDate" required>

        <button class="btn" onclick="calculateInterest()">Calculate Interest</button>
    </form>
    <table id="summaryTable" style="width:100%; margin: 18px 0 0 0; border-collapse:collapse; display:none;">
        <thead>
        <tr>
            <th>Name</th>
            <th>Warehouse</th>
            <th>Commodity</th>
            <th>Cash Loan (₹)</th>
            <th>Margin Loan (₹)</th>
            <th>Margin Paid (₹)</th>
            <th>Interest Due (₹)</th>
        </tr>
        </thead>
        <tbody>
        <tr id="summaryRow"></tr>
        </tbody>
    </table>

    <button class="btn" id="showDetailsBtn" style="display:none;" onclick="showDetails()">Show Details</button>

    <div id="detailsDiv" style="display:none;">
        <div id="detailsHeader">
        </div>
        <table class="details-table" id="detailsTable"></table>
    </div>
</div>
<script>
    let interestDetails = [];

    function calculateInterest() {
        let stockistName = document.getElementById("stockistName").value;
        let warehouse = document.getElementById("warehouse").value;
        let commodity = document.getElementById("commodity").value;
        let uptoDate = document.getElementById("uptoDate").value;
        if(!stockistName || !warehouse || !commodity || !uptoDate) { alert("Fill all fields!"); return; }
        fetch('/user/interest-calculator/calculate', {
            method: "POST",
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `stockistName=${encodeURIComponent(stockistName)}&warehouse=${encodeURIComponent(warehouse)}&commodity=${commodity}&uptoDate=${uptoDate}`
        })
            .then(res => res.json())
            .then(resp => {
                let sum = resp.summary;
                const table = document.getElementById("summaryTable");
                const row = document.getElementById("summaryRow");
                row.innerHTML = `
    <td>${sum.stockistName}</td>
    <td>${sum.warehouse}</td>
    <td>${sum.commodity}</td>
    <td>${(sum.cashLoan||0).toFixed(2)}</td>
    <td>${(sum.marginLoan||0).toFixed(2)}</td>
    <td>${(sum.marginPaid||0).toFixed(2)}</td>
    <td>${(sum.interestDue||0).toFixed(2)}</td>
`;
                table.style.display = '';

                interestDetails = resp.details || [];
                document.getElementById("showDetailsBtn").style.display = interestDetails.length > 0 ? '' : 'none';
                document.getElementById("detailsDiv").style.display = 'none';
            });
    }

    function showDetails() {
        let tbl = document.getElementById("detailsTable");
        tbl.innerHTML = "";
        let header = "<tr><th>Date</th><th>Cash Loan</th><th>Margin Loan</th><th>Margin Paid</th><th>Net Loan</th><th>Day's Interest</th><th>Cumulative Interest</th></tr>";
        tbl.insertAdjacentHTML('beforeend', header);
        interestDetails.forEach(row => {
            tbl.insertAdjacentHTML('beforeend',
                `<tr>
                    <td>${row.date}</td>
                    <td>${row.cashLoan.toFixed(2)}</td>
                    <td>${row.marginLoan.toFixed(2)}</td>
                    <td>${row.marginPaid.toFixed(2)}</td>
                    <td>${row.netLoan.toFixed(2)}</td>
                    <td>${row.interest.toFixed(2)}</td>
                    <td>${row.cumulative.toFixed(2)}</td>
                </tr>`);
        });
        document.getElementById("detailsDiv").style.display = '';
    }
</script>
</body>
</html>

